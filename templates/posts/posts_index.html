{% extends 'common/base.html' %}

{% block title %}All Posts{% endblock %}

{% block content %}
<div class="container">
    {% if messages %}
    {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
            {{ message }}
        </div>
    {% endfor %}
    {% endif %}
    <h1 class="text-center mb-4">All Missing Person Posts</h1>
    <a href="{% url 'posts:create_missing_person' %}" class="btn btn-primary mb-3">Post</a>

    <div class="row">
        {% for data in post_data %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <img src="{{ data.post.photo.url }}" class="card-img-top" alt="{{ data.post.name }} Photo" style="object-fit: cover; height: 200px;">
                <div class="card-body">
                    <a href="#" class="mr-2 comment-btn" data-post-id="{{ data.post.id }}" data-toggle="modal" data-target="#commentModal"><i class="fa fa-comment"></i></a>

                    <!-- Comments container -->
                    <div id="comments-{{ data.post.id }}" class="comments-container" style="display: none;">
                        {% for comment in data.comments %}
                        <hr>
                            <p>{{ comment.text }}</p>
                            <!-- Add an element to toggle visibility of replies -->
                            <span class="toggle-replies" data-comment-id="{{ comment.id }}">▼ Show Replies</span>
                            <div class="replies-container" style="display: none;">
                                <!-- Render replies here -->
                                {% for reply in comment.replies.all %}
                                    <p><strong>{{ reply.user.username }}</strong> replied: {{ reply.text }}</p>
                                    <!-- Render other reply details as needed -->
                                {% endfor %}
                            </div>
                        <hr>
                        {% endfor %}
                    
                    
                    </div>

                    <a href="#" class="toggle-comments-link" data-toggle="comments-{{ data.post.id }}">View all comments</a>

                    <!-- Display the like/react icon -->
                    <span class="btn btn-link like-btn" id="react-btn" data-post-id="{{ data.post.id }}">
                        <i class="fa fa-heart-o"></i> <!-- Use Font Awesome heart icon -->
                    </span>
                    <!-- Display the like count -->
                    <span class="like-count" id="like-count">{{ data.post.liked_by.count }}</span>
                    <!-- Reaction/Like -->
                    <div class="reaction">
                        <!-- Update the like button to include an id attribute -->
                    </div>
                    <h5 class="card-title">{{ data.post.name }}</h5>
                    <p class="card-text">{{ data.post.description }}</p>
                    <p class="card-text"><small class="text-muted">Location: {{ data.post.location }}</small></p>
                    <p class="card-text"><small class="text-muted">Date Missing: {{ data.post.date_missing }}</small></p>
                    <p class="card-text"><small class="text-muted">Posted by: 
                        {% if data.post.user.username == request.user.username %}
                            <a href="{% url 'accounts:user_profile' username=data.post.user.username %}">You</a></small>
                        {% else %}
                            <a href="{% url 'accounts:user_profile' username=data.post.user.username %}">{{ data.post.user.username }}</a></small>
                        {% endif %}
                    </p>
                </div>
                <div class="card-footer">
                    <a href="{% url 'posts:view_post_details' post_id=data.post.id %}" class="btn btn-primary float-right">View More Details</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>


<!-- Modal for commenting -->
<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">Comment on Post</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="comment-form" method="post" action="{% url 'posts:comment_on_post' 0 %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="comment-text">Leave a Comment:</label>
                        <textarea class="form-control" id="comment-text" name="text" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Comment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for replying to comments -->
<div class="modal fade" id="replyModal" tabindex="-1" role="dialog" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="replyModalLabel">Reply to Comment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="reply-form" method="post" action="{% url 'posts:reply_to_comment' comment_id=0 %}">
                    {% csrf_token %}
                    <input type="hidden" name="comment_id" class="comment-id" value="">
                    <div class="form-group">
                        <label for="reply-text">Your Reply:</label>
                        <textarea class="form-control reply-text" name="text" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Reply</button>
                </form>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function () {
    // Attach click event handler to reply buttons
    $('.reply-btn').click(function (e) {
        e.preventDefault(); // Prevent default link behavior
        
        // Get the comment ID from the button data attribute
        var commentId = $(this).data('comment-id');

        // Set the comment ID in the hidden input field of the reply form
        $('#reply-form').find('.comment-id').val(commentId);

        // Show the modal for replying to comment
        $('#replyModal').modal('show');
    });

    // Handle form submission for replying to a comment
    $('#reply-form').submit(function (e) {
        e.preventDefault(); // Prevent default form submission
        
        // Serialize form data
        var formData = $(this).serialize();

        // Submit the form via AJAX
        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: formData,
            success: function (response) {
                // Optionally, you can refresh the comments section to show the new reply
                // Close the modal for replying to comment
                $('#replyModal').modal('hide');
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    });
});

</script>

<script>

$(document).ready(function () {
    // Attach click event handler to toggle-replies elements
    $('.toggle-replies').click(function () {
        // Toggle the visibility of replies container associated with the clicked comment
        $(this).siblings('.replies-container').toggle();
        // Change the text of the toggle-replies element to reflect its current state
        $(this).text(function (i, text) {
            return text === '▼ Show Replies' ? '▲ Hide Replies' : '▼ Show Replies';
        });
    });
});


</script>
{% endblock %}
